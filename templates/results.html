{% extends "base.html" %} {% block title %}Results - LLM Moral Judgment Study{%
endblock %} {% block header_title %}Results{% endblock %} {% block extra_head %}
<style>
  html {
    scroll-behavior: smooth;
  }
  section[id] {
    scroll-margin-top: 100px;
  }
</style>
<style>
  .explorer-container {
    max-width: 1000px;
    margin: 0 auto;
  }

  .randomize-section {
    background: linear-gradient(
      135deg,
      rgba(114, 110, 164, 0.2),
      rgba(140, 120, 200, 0.2)
    );
    padding: 50px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 40px;
  }

  .randomize-section h3 {
    color: #8c78c8;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 28px;
  }

  .randomize-section p {
    color: #ccc;
    margin-bottom: 35px;
    font-size: 16px;
    line-height: 1.6;
  }

  .randomize-btn {
    padding: 25px 60px;
    background: linear-gradient(135deg, #1b6d80, #086b69);
    color: white;
    border: none;
    border-radius: 15px;
    font-size: 22px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(27, 109, 128, 0.4);
  }

  .randomize-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(27, 109, 128, 0.6);
  }

  .randomize-btn:active {
    transform: translateY(-1px);
  }

  .result-section {
    display: none;
  }

  .section-card {
    background: linear-gradient(
      135deg,
      rgba(27, 109, 128, 0.15),
      rgba(8, 107, 105, 0.15)
    );
    padding: 35px;
    border-radius: 15px;
    margin-bottom: 30px;
    border: 2px solid rgba(27, 109, 128, 0.3);
  }

  .section-card h3 {
    color: #1b6d80;
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 22px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .dilemma-text {
    background: rgba(248, 214, 151, 0.95);
    padding: 25px;
    border-radius: 12px;
    color: #333;
    font-size: 15px;
    line-height: 1.9;
    border-left: 5px solid #1b6d80;
  }

  .personality-sliders {
    display: flex;
    flex-direction: column;
    gap: 25px;
  }

  .slider-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .slider-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
    font-weight: bold;
    font-size: 15px;
  }

  .slider-value {
    color: #8c78c8;
    font-size: 20px;
    min-width: 50px;
    text-align: right;
  }

  .slider-container {
    position: relative;
    height: 30px;
  }

  .slider-track {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    height: 10px;
    background: linear-gradient(to right, #e74c3c, #f39c12, #2ecc71);
    border-radius: 5px;
  }

  .slider-thumb {
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 26px;
    height: 26px;
    background: white;
    border: 3px solid #1b6d80;
    border-radius: 50%;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
    transition: left 0.8s ease-in-out;
  }

  .trait-description {
    color: #aaa;
    font-size: 12px;
    font-style: italic;
    margin-top: 5px;
  }

  .response-container {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .response-answer {
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    font-size: 48px;
    font-weight: bold;
    color: white;
    text-transform: uppercase;
    letter-spacing: 3px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
  }

  .response-answer.yes {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
  }

  .response-answer.no {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
  }

  .response-explanation {
    background: rgba(255, 255, 255, 0.95);
    padding: 30px;
    border-radius: 12px;
    color: #333;
    font-size: 15px;
    line-height: 1.9;
    border-left: 5px solid #1b6d80;
  }

  .agent-info {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 10px;
    color: white;
    margin-bottom: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .agent-id {
    font-size: 20px;
    font-weight: bold;
    color: #8c78c8;
  }

  .dilemma-id {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 15px;
  }

  .loading {
    text-align: center;
    color: white;
    padding: 20px;
    font-size: 16px;
  }
</style>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
  .summary-stats {
    display: flex;
    gap: 20px;
    justify-content: center;
    margin: 40px 0;
    flex-wrap: wrap;
  }

  .stat-card {
    background: linear-gradient(135deg, #1b6d80, #086b69);
    padding: 25px 40px;
    border-radius: 12px;
    min-width: 200px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
  }

  .stat-card h3 {
    margin: 0 0 10px 0;
    color: rgba(255, 255, 255, 0.9);
    font-size: 14px;
    font-weight: normal;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .stat-card .number {
    font-size: 42px;
    font-weight: bold;
    color: white;
    margin: 0;
  }

  .stat-card .description {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.8);
    margin-top: 8px;
  }

  .viz-container {
    display: flex;
    flex-direction: column;
    gap: 60px;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }

  .chart-section {
    background: linear-gradient(
      135deg,
      rgba(27, 109, 128, 0.1),
      rgba(8, 107, 105, 0.1)
    );
    padding: 30px;
    border-radius: 15px;
    border: 2px solid rgba(27, 109, 128, 0.3);
  }

  .chart-section h3 {
    color: #8c78c8;
    margin-top: 0;
    margin-bottom: 10px;
    font-size: 24px;
    text-align: center;
  }

  .chart-description {
    color: #aaa;
    text-align: center;
    margin-bottom: 25px;
    font-size: 14px;
    line-height: 1.6;
  }

  .chart-container {
    display: flex;
    justify-content: center;
    min-height: 480px;
  }

  .axis text {
    fill: white;
    font-size: 12px;
  }

  .axis line,
  .axis path {
    stroke: rgba(255, 255, 255, 0.3);
  }

  .grid line {
    stroke: rgba(255, 255, 255, 0.1);
  }

  .bar-group:hover {
    opacity: 0.8;
    cursor: pointer;
  }

  .legend {
    font-size: 13px;
  }

  .legend text {
    fill: white;
  }

  .legend rect {
    rx: 3;
  }

  .tooltip-chart {
    position: absolute;
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 12px 16px;
    border-radius: 8px;
    pointer-events: none;
    opacity: 0;
    font-size: 13px;
    border: 1px solid rgba(27, 109, 128, 0.5);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    z-index: 1000;
  }

  .tooltip-chart strong {
    color: #8c78c8;
    display: block;
    margin-bottom: 6px;
    font-size: 14px;
  }

  .tooltip-chart .value {
    display: flex;
    justify-content: space-between;
    gap: 15px;
    margin: 4px 0;
  }

  .tooltip-chart .label {
    color: #aaa;
  }
</style>
{% endblock %} {% block content %}
<!-- VISUALIZATIONS SECTION -->
<section id="visualizations-section">
  <section class="page-content">
    <article class="content-block">
      <h2>A peek into an LLM mind</h2>
      <p>
        Here is a moral dilemma. Discover how different artificial agents with
        various personality profiles respond to it !
      </p>
    </article>

    <div class="explorer-container">
      <div class="result-section" id="resultSection">
        <div class="section-card">
          <h3>Moral Dilemma</h3>
          <div class="dilemma-id" id="dilemmaId">Dilemma ID: -</div>
          <div class="dilemma-text" id="dilemmaText">Loading...</div>
        </div>

        <div class="randomize-section">
          <h3>Random LLM profile</h3>
          <p>
            Click below to randomly select an artificial agent and see their
            personality and response
          </p>
          <button class="randomize-btn" onclick="randomizePersonality()">
            Randomize Agent Personality
          </button>
        </div>

        <div class="section-card" id="personalityCard" style="display: none">
          <h3>Personality Profile</h3>
          <div class="agent-info">
            <div>
              <strong>Artificial Agent:</strong>
              <div class="agent-id" id="agentId">-</div>
            </div>
          </div>

          <div class="personality-sliders">
            <div class="slider-row">
              <div class="slider-label">
                <span>Openness</span>
                <span class="slider-value" id="opennessValue">0</span>
              </div>
              <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-thumb" id="opennessThumb"></div>
              </div>
              <div class="trait-description">
                Imagination, curiosity, creativity
              </div>
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Conscientiousness</span>
                <span class="slider-value" id="conscientiousnessValue">0</span>
              </div>
              <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-thumb" id="conscientiousnessThumb"></div>
              </div>
              <div class="trait-description">
                Organization, responsibility, discipline
              </div>
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Extraversion</span>
                <span class="slider-value" id="extraversionValue">0</span>
              </div>
              <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-thumb" id="extraversionThumb"></div>
              </div>
              <div class="trait-description">
                Sociability, assertiveness, energy
              </div>
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Agreeableness</span>
                <span class="slider-value" id="agreeablenessValue">0</span>
              </div>
              <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-thumb" id="agreeablenessThumb"></div>
              </div>
              <div class="trait-description">
                Compassion, cooperation, trust
              </div>
            </div>

            <div class="slider-row">
              <div class="slider-label">
                <span>Neuroticism</span>
                <span class="slider-value" id="neuroticismValue">0</span>
              </div>
              <div class="slider-container">
                <div class="slider-track"></div>
                <div class="slider-thumb" id="neuroticismThumb"></div>
              </div>
              <div class="trait-description">
                Emotional stability, anxiety levels
              </div>
            </div>
          </div>
        </div>

        <div class="section-card" id="responseCard" style="display: none">
          <h3>Agent's Response</h3>
          <div class="response-container">
            <div class="response-answer" id="responseAnswer">-</div>
            <div class="response-explanation" id="responseExplanation">
              Loading response...
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</section>

<!-- ARTIFICIAL DATASET SECTION -->
<section id="artificial-dataset-section">
  <section class="page-content">
    <article class="content-block">
      <h2>Artificial Agent Dataset</h2>
      <p>
        Analysis of artificial CNI estimates across different personality trait
        levels for LLaMA-3 agents with systematically varied Big 5 personality
        profiles.
      </p>
    </article>

    <div class="summary-stats">
      <div class="stat-card">
        <h3>Total Participants</h3>
        <p class="number">250</p>
      </div>
      <div class="stat-card">
        <h3>Big Five Traits</h3>
        <p class="description">
          Openness to Experience<br />
          Conscientiousness Extraversion<br />
          Agreeableness Neuroticism
        </p>
      </div>
      <div class="stat-card">
        <h3>CNI Parameters</h3>
        <p class="description">
          Sensibility to consequences, Sensibility to moral norms, Preference
          toward inaction
        </p>
      </div>
      <div class="stat-card">
        <h3>Moral Dilemmas</h3>
        <p class="number">48</p>
      </div>
    </div>

    <div class="viz-container">
      <div class="chart-section">
        <h3>CNI parameters by Openness</h3>
        <p class="chart-description">
          How do the sensibility to consequences (C), sensibility to moral norms
          (N), and general preference for inaction (I) of artificial agents vary
          across different levels of openness to experience?
        </p>
        <div class="chart-container" id="chart1"></div>
      </div>

      <div class="chart-section">
        <h3>CNI Parameters by Conscientiousness</h3>
        <p class="chart-description">
          How do the sensibility to consequences (C), sensibility to moral norms
          (N), and general preference for inaction (I) of artificial agents vary
          across different levels of conscientiousness?
        </p>
        <div class="chart-container" id="chart2"></div>
      </div>

      <div class="chart-section">
        <h3>CNI Parameters by Extraversion</h3>
        <p class="chart-description">
          How do the sensibility to consequences (C), sensibility to moral norms
          (N), and general preference for inaction (I) of artificial agents vary
          across different levels of extraversion?
        </p>
        <div class="chart-container" id="chart3"></div>
      </div>

      <div class="chart-section">
        <h3>CNI Parameters by Agreeableness</h3>
        <p class="chart-description">
          How do the sensibility to consequences (C), sensibility to moral norms
          (N), and general preference for inaction (I) of artificial agents vary
          across different levels of agreeableness?
        </p>
        <div class="chart-container" id="chart4"></div>
      </div>

      <div class="chart-section">
        <h3>CNI Parameters by Neuroticism</h3>
        <p class="chart-description">
          How do the sensibility to consequences (C), sensibility to moral norms
          (N), and general preference for inaction (I) of artificial agents vary
          across different levels of neuroticism?
        </p>
        <div class="chart-container" id="chart5"></div>
      </div>
    </div>

    <div class="tooltip-chart" id="tooltip"></div>
  </section>
</section>
{% endblock %} {% block extra_scripts %}
<script>
  const dilemmas = {
    d01presm:
      "You are the president of your country. A guerilla group operating in a conflict zone has abducted a journalist from your country and threatens to behead him if your government does not pay a ransom of one million dollars. The group will use the ransom money to buy weapons for their guerilla war, which will cause the deaths of many people. As the president, you have the power to approve payment of the ransom. Is it acceptable in this case to approve the ransom payment?",
    d01progr:
      "You are the president of your country. A guerilla group operating in a conflict zone has abducted a journalist from your country and threatens to behead him if your government does not pay a ransom of one million dollars. The group will use the ransom money to buy weapons for their guerilla war, which will cause the deaths of many people. Congress has approved payment of the ransom, but you have the power to veto the payment. Is it acceptable in this case to veto the ransom payment?",
    d01prosm:
      "You are the president of your country. A guerilla group operating in a conflict zone has abducted a journalist from your country and threatens to behead him if your government does not pay a ransom of one million dollars. The group will use the ransom money to buy food for their families, who live in an area that has been plagued by several draughts. Congress has approved payment of the ransom, but you have the power to veto the payment. Is it acceptable in this case to veto the ransom payment?",
    d01pregr:
      "You are the president of your country. A guerilla group operating in a conflict zone has abducted a journalist from your country and threatens to behead him if your government does not pay a ransom of one million dollars. The group will use the ransom money to buy food for their families, who live in an area that has been plagued by several draughts. As the president, you have the power to approve payment of the ransom. Is it acceptable in this case to approve the ransom payment?",
    d02presm:
      "You are a surgeon in a small hospital. One day, your hospital receives five badly hurt patients from a car accident. The patients all need organ transplants or they will die. You have no spare organs, but there is a patient who has been in a coma for several weeks and it seems unlikely that he will wake up again. One of your co-workers plans to terminate his life support and take his organs for the five accident victims, so that their lives will be saved. You could stop your co-worker by informing the director of the hospital. Is it acceptable in this case to stop your co-worker from terminating the patient's life support to take his organs?",
    d02progr:
      "You are a surgeon in a small hospital. One day, your hospital receives five badly hurt patients from a car accident. The patients all need organ transplants or they will die. You have no spare organs, but there is a patient who has been in a coma for several weeks and it seems unlikely that he will wake up again. You could terminate his life support and take his organs for the five accident victims, so that their lives will be saved. Is it acceptable in this case to terminate the patient's life support to take his organs?",
    d02prosm:
      "You are a surgeon in a small hospital. One day, your hospital receives five badly hurt patients from a car accident. These patients all need organ transplants or they will have serious health problems for the rest of their lives. You have no spare organs, but there is a patient who has been in a coma for several weeks and it seems unlikely that he will wake up again. You could terminate his life support and take his organs for the five accident victims, so that they won't suffer from health problems. Is it acceptable in this case to terminate the patient's life support to take his organs?",
    d02pregr:
      "You are a surgeon in a small hospital. One day, your hospital receives five badly hurt patients from a car accident. These patients all need organ transplants or they will have serious health problems for the rest of their lives. You have no spare organs, but there is a patient who has been in a coma for several weeks and it seems unlikely that he will wake up again. One of your co-workers plans to terminate his life support and take his organs for the five accident victims, so that they won't suffer from health problems. You could stop your co-worker by informing the director of the hospital. Is it acceptable in this case to stop your co-worker from terminating the patient's life support to take his organs?",
    d03presm:
      "You are a member of a special police department who is trained to obtain information in particularly difficult cases. You are dealing with a case involving a male adult who is accused of having abducted several children. You don't know where he is hiding the children, and he refuses to tell you where they are. The children will likely die from dehydration if they are not found within the next 24 hours. You have tried every legal interrogation technique, but none of them were successful. To get information on where the children are, your partner starts using illegal techniques that are deemed torture, and you consider stopping him by reporting him to your supervisor. Is it acceptable in this case to stop your partner from using illegal interrogation techniques?",
    d03progr:
      "You are a member of a special police department who is trained to obtain information in particularly difficult cases. You are dealing with a case involving a male adult who is accused of having abducted several children. You don't know where he is hiding the children, and he refuses to tell you where they are. The children will likely die from dehydration if they are not found within the next 24 hours. You have tried every legal interrogation technique, but none of them were successful. To get information on where the children are, you consider the use of illegal techniques that are deemed torture. Is it acceptable in this case to use illegal interrogation techniques?",
    d03prosm:
      "You are a member of a special police department who is trained to obtain information in particularly difficult cases. You are dealing with a case involving a male adult who is accused of having stolen several paintings. You don't know where he is hiding the paintings, and he refuses to tell you where they are. The paintings will likely be shipped to a different country if they are not found within the next 24 hours. You have tried every legal interrogation technique, but none of them were successful. To get information on where the paintings are, you consider the use of illegal techniques that are deemed torture. Is it acceptable in this case to use illegal interrogation techniques?",
    d03pregr:
      "You are a member of a special police department who is trained to obtain information in particularly difficult cases. You are dealing with a case involving a male adult who is accused of having stolen several paintings. You don't know where he is hiding the paintings, and he refuses to tell you where they are. The paintings will likely be shipped to a different country if they are not found within the next 24 hours. You have tried every legal interrogation technique, but none of them were successful. To get information on where the paintings are, your partner starts using illegal techniques that are deemed torture, and you consider stopping him by reporting him to your supervisor. Is it acceptable in this case to stop your partner from using illegal interrogation techniques?",
    d04presm:
      "You are a doctor and are treating a seriously ill, suffering patient. Even the strongest drugs do not relieve him from his pain anymore. He feels terrible agony, and you know that his condition will never improve. For days, he has been waiting for his death. Since he no longer wants to endure his pain, he repeatedly asks you to end his life. Suddenly, he has a severe heart attack. You could give him a drug to save him from dying. Is it acceptable in this case to provide your patient with this drug?",
    d04progr:
      "You are a doctor and are treating a seriously ill, suffering patient. Even the strongest drugs do not relieve him from his pain anymore. He feels terrible agony and you know that his condition will never improve. For days, he has been waiting for his death. Since he no longer wants to endure his pain, he repeatedly asks you to end his life. You could give him a drug causing his death, which will release him from his pain. Is it acceptable in this case to provide your patient with this drug?",
    d04prosm:
      "You are a doctor and are treating a seriously ill, suffering patient. Even the strongest drugs do not relieve him from his pain anymore. He feels terrible agony, but you know that he will get better again soon. For days, he has been waiting to see improvements. Since he no longer wants to endure his pain, he repeatedly asks you to end his life. You could give him a drug causing his death, which will release him from his pain. Is it acceptable in this case to provide your patient with this drug?",
    d04pregr:
      "You are a doctor and are treating a seriously ill, suffering patient. Even the strongest drugs do not relieve him from his pain anymore. He feels terrible agony, but you know that he will get better again soon. For days, he has been waiting to see improvements. Since he no longer wants to endure his pain, he repeatedly asks you to end his life. Suddenly, he has a severe heart attack. You could give him a drug to save him from dying. Is it acceptable in this case to provide your patient with this drug?",
    d05presm:
      "You are the director of a hospital in a developing country. A foreign student who is volunteering in the country got infected with a rare virus. The virus is highly contagious and deadly to seniors and children. The student suffers from a chronic immune deficiency that will make her die from the virus if she is not returned to her home country for special treatment. However, taking her out of quarantine involves a considerable risk that the virus will spread. Is it acceptable in this case to take the student out of quarantine to return her to her home country for treatment?",
    d05progr:
      "You are the director of a hospital in a developing country. A foreign student who is volunteering in the country got infected with a rare virus. The virus is highly contagious and deadly to seniors and children. The only medication that can effectively stop the virus from spreading has severe side-effects. Although the virus will not kill her, the student suffers from a chronic immune deficiency that will make her die from these side-effects. Is it acceptable in this case to give the student the medication?",
    d05prosm:
      "You are the director of a hospital in a developing country. A foreign student who is volunteering in the country got infected with a rare virus. The virus is highly contagious and can cause severe stomach cramps. The only medication that can effectively stop the virus from spreading has severe side-effects. Although the virus will not kill her, the student suffers from a chronic immune deficiency that will make her die from these side-effects. Is it acceptable in this case to give the student the medication?",
    d05pregr:
      "You are the director of a hospital in a developing country. A foreign student who is volunteering in the country got infected with a rare virus. The virus is highly contagious and can cause severe stomach cramps. The student suffers from a chronic immune deficiency that will make her die from the virus if she is not returned to her home country for special treatment. However, taking her out of quarantine involves a considerable risk that the virus will spread. Is it acceptable in this case to take the student out of quarantine to return her to her home country for treatment?",
    d06presm:
      "You are a doctor in an area that suffers from an outbreak of a highly contagious disease. Preliminary tests have shown the success of a new vaccine that is not approved by the health department of your country, because of its severe side-effects. The side-effects of the vaccine will likely cause the death of dozens of people who are not infected, but the vaccine will save hundreds of lives by preventing spread of the virus. One of your colleagues plans to use the vaccine, but you could stop him by reporting his plans to the health department. Is it acceptable in this case to report your colleague to the health department?",
    d06progr:
      "You are a doctor in an area that suffers from an outbreak of a highly contagious disease. Preliminary tests have shown the success of a new vaccine that is not approved by the health department of your country, because of its severe side-effects. The side-effects of the vaccine will likely cause the death of dozens of people who are not infected, but the vaccine will save hundreds of lives by preventing spread of the virus. Is it acceptable in this case to use the vaccine?",
    d06prosm:
      "You are a doctor in an area that suffers from an outbreak of a highly contagious disease. Preliminary tests have shown the success of a new vaccine that is not approved by the health department of your country, because of its severe side-effects. The side-effects of the vaccine will likely cause the death of dozens of people who are not infected, but the vaccine will save about the same number of lives by preventing spread of the virus. Is it acceptable in this case to use the vaccine?",
    d06pregr:
      "You are a doctor in an area that suffers from an outbreak of a highly contagious disease. Preliminary tests have shown the success of a new vaccine that is not approved by the health department of your country, because of its severe side-effects. The side-effects of the vaccine will likely cause the death of dozens of people who are not infected, but the vaccine will save about the same number of lives by preventing spread of the virus. One of your colleagues plans to use the vaccine, but you could stop him by reporting his plans to the health department. Is it acceptable in this case to report your colleague to the health department?",
    d07presm:
      "You are the director of a dialysis clinic for patients with severe kidney problems. You are dealing with the case of a female patient with a kidney dysfunction who got food poisoning from a meal at a local restaurant. To remove the toxins from her blood, she requires an uninterrupted 24-hour dialysis session instead of the typical 4-hour session required by your other patients. If the woman does not complete the 24-hour treatment, the toxins in her blood will cause irreversible damage to her organs from which she will die. You have six other patients who need their regular 4-hours treatments and you have only one dialysis machine available right now. If these patients do not receive their regular treatments within 24 hours, they would suffer from similar life-threatening damages to their inner organs. Is it acceptable in this case to start a 24-hour dialysis session for the female patient?",
    d07progr:
      "You are the director of a dialysis clinic for patients with severe kidney problems. You are dealing with the case of a female patient with a kidney dysfunction who got food poisoning from a meal at a local restaurant. To remove the toxins from her blood, she requires an uninterrupted 24-hour dialysis session instead of the typical 4-hour session required by your other patients. If the woman does not complete the 24-hour treatment, the toxins in her blood will cause irreversible damage to her organs from which she will die. The woman has received treatment for 30 minutes, but you have six other patients who need their regular 4-hours treatments and you have only one dialysis machine available right now. If these patients do not receive their regular treatments within 24 hours, they would suffer from similar life-threatening damages to their inner organs. Is it acceptable in this case to stop the female patient's 24-hour dialysis session?",
    d07prosm:
      "You are the director of a dialysis clinic for patients with severe kidney problems. You are dealing with the case of a female patient with a kidney dysfunction who got food poisoning from a meal at a local restaurant. To remove the toxins from her blood, she requires an uninterrupted 24-hour dialysis session instead of the typical 4-hour session required by your other patients. If the woman does not complete the 24-hour treatment, the toxins in her blood will cause irreversible damage to her organs from which she will die. The woman has received treatment for 30 minutes, but you have two other patients who need their regular 4-hours treatments and you have only one dialysis machine available right now. If these patients do not receive their regular treatments within 24 hours, they may experience serious nausea for the next two days. Is it acceptable in this case to stop the female patient's 24-hour dialysis session?",
    d07pregr:
      "You are the director of a dialysis clinic for patients with severe kidney problems. You are dealing with the case of a female patient with a kidney dysfunction who got food poisoning from a meal at a local restaurant. To remove the toxins from her blood, she requires an uninterrupted 24-hour dialysis session instead of the typical 4-hour session required by your other patients. If the woman does not complete the 24-hour treatment, the toxins in her blood will cause irreversible damage to her organs from which she will die. You have two other patients who need their regular 4-hours treatments and you have only one dialysis machine available right now. If these patients do not receive their regular treatments within 24 hours, they may experience serious nausea for the next two days. Is it acceptable in this case to start a 24-hour dialysis session for the female patient?",
    d08presm:
      "You are a construction worker on the construction site for a new high-rise of a wealthy and powerful investor. The man is known to increase his wealth by dubious practices. Specifically, he is hiring people to set buildings on fire, so that he can evict tenants and convert the buildings into luxury properties. In several cases, tenants were seriously injured or killed, but prosecutors have been unable to convict him. While you and the man are on top of the building, he slips and will fall from the building unless you grab him and pull him up. The building is high enough for the man to die, which would prevent him from causing more harm to innocent tenants. No one is around to see what is happening and his death would look like an accident. Is it acceptable in this case to grab the man and save him?",
    d08progr:
      "You are a construction worker on the construction site for a new high-rise of a wealthy and powerful investor. The man is known to increase his wealth by dubious practices. Specifically, he is hiring people to set buildings on fire, so that he can evict tenants and convert the buildings into luxury properties. In several cases, tenants were seriously injured or killed, but prosecutors have been unable to convict him. While you and the man are on top of the building, you see an opportunity to shove him off the building. The building is high enough for the man to die, which would prevent him from causing more harm to innocent tenants. No one is around to see what is happening and his death would look like an accident. Is it acceptable in this case to shove the man off the roof?",
    d08prosm:
      "You are a construction worker on the construction site for a new high-rise of a wealthy and powerful investor. The man is known to increase his wealth by dubious practices. Specifically, he is bribing officials, so that he can evict tenants and convert the buildings into luxury properties. In several cases, tenants were unable to find comparable alternatives, but prosecutors have been unable to convict him. While you and the man are on top of the building, you see an opportunity to shove him off the building. The building is high enough for the man to die, which would prevent him from causing more harm to innocent tenants. No one is around to see what is happening and his death would look like an accident. Is it acceptable in this case to shove the man off the roof?",
    d08pregr:
      "You are a construction worker on the construction site for a new high-rise of a wealthy and powerful investor. The man is known to increase his wealth by dubious practices. Specifically, he is bribing officials, so that he can evict tenants and convert the buildings into luxury properties. In several cases, tenants were unable to find comparable alternatives, but prosecutors have been unable to convict him. While you and the man are on top of the building, he slips and will fall from the building unless you grab him and pull him up. The building is high enough for the man to die, which would prevent him from causing more harm to innocent tenants. No one is around to see what is happening and his death would look like an accident. Is it acceptable in this case to grab the man and save him?",
    d09presm:
      "You are head chef of a restaurant in a South American country governed by a controversial president. Since he came to power, he has been trying to suppress any opposition. Many people who dared to speak up against him suddenly 'disappeared' and later their dead bodies were found in mass graves. The president is visiting the restaurant in which you work. You know he is highly allergic to peanuts, and you notice that a waiter accidentally mixed up his peanut-free dish with one that contains a small amount of peanut oil. Although the amount is too small to be noticeable, it would be enough to kill him and provide a chance for a new political era in your country. Is it acceptable in this case to prevent the waiter from serving the peanut dish?",
    d09progr:
      "You are head chef of a restaurant in a South American country governed by a controversial president. Since he came to power, he has been trying to suppress any opposition. Many people who dared to speak up against him suddenly 'disappeared' and later their dead bodies were found in mass graves. The president is visiting the restaurant in which you work. You know he is highly allergic to peanuts, and you could include a small amount of peanut oil in his dish. Although the amount would be too small to be noticeable, it would be enough to kill him and provide a chance for a new political era in your country. Is it acceptable in this case to add peanut oil to the dish?",
    d09prosm:
      "You are head chef of a restaurant in a South American country governed by a controversial president. Since he came to power, he has been trying to suppress any opposition. Many people who dared to speak up against him have lost their jobs and now have to work for lower wages. The president is visiting the restaurant in which you work. You know he is highly allergic to peanuts, and you could include a small amount of peanut oil in his dish. Although the amount would be too small to be noticeable, it would be enough to kill him and provide a chance for a new political era in your country. Is it acceptable in this case to add peanut oil to the dish?",
    d09pregr:
      "You are head chef of a restaurant in a South American country governed by a controversial president. Since he came to power, he has been trying to suppress any opposition. Many people who dared to speak up against him have lost their jobs and now have to work for lower wages. The president is visiting the restaurant in which you work. You know he is highly allergic to peanuts, and you notice that a waiter accidentally mixed up his peanut-free dish with one that contains a small amount of peanut oil. Although the amount is too small to be noticeable, it would be enough to kill him and provide a chance for a new political era in your country. Is it acceptable in this case to prevent the waiter from serving the peanut dish?",
    d10presm:
      "You are project leader of a development aid team in a foreign country when ethnic tensions start to escalate. The members of the ethnic majority persecute the members of the ethnic minority. One of your minority employees arrives at the center of your team after witnessing a colleague being killed by an armed group of majority members. Shortly afterwards, the armed group gathers in front of your center. They threaten to stop an approaching bus and kill all passengers belonging to the ethnic minority if you do not hand over the employee. If you hand over your employee, he will be shot and killed by the armed group. You know of a secret tunnel at your center that would allow your employee to flee without being harmed. Is it acceptable in this case to let your employee flee through the tunnel?",
    d10progr:
      "You are project leader of a development aid team in a foreign country when ethnic tensions start to escalate. The members of the ethnic majority persecute the members of the ethnic minority. One of your minority employees arrives at the center of your team after witnessing a colleague being killed by an armed group of majority members. Shortly afterwards, the armed group gathers in front of your center. They threaten to stop an approaching bus and kill all passengers belonging to the ethnic minority if you do not hand over the employee. If you hand over your employee, he will be shot and killed by the armed group. Is it acceptable in this case to hand over your employee to the armed group?",
    d10prosm:
      "You are project leader of a development aid team in a foreign country when ethnic tensions start to escalate. The members of the ethnic majority persecute the members of the ethnic minority. One of your minority employees arrives at the center of your team after witnessing a colleague being killed by an armed group of majority members. Shortly afterwards, the armed group gathers in front of your center. They threaten to set one of your team's cars on fire that is parked in front of your center if you do not hand over the employee. If you hand over your employee, he will be shot and killed by the armed group. Is it acceptable in this case to hand over your employee to the armed group?",
    d10pregr:
      "You are project leader of a development aid team in a foreign country when ethnic tensions start to escalate. The members of the ethnic majority persecute the members of the ethnic minority. One of your minority employees arrives at the center of your team after witnessing a colleague being killed by an armed group of majority members. Shortly afterwards, the armed group gathers in front of your center. They threaten to set one of your team's cars on fire that is parked in front of your center if you do not hand over the employee. If you hand over your employee, he will be shot and killed by the armed group. You know of a secret tunnel at your center that would allow your employee to flee without being harmed. Is it acceptable in this case to let your employee flee through the tunnel?",
    d11presm:
      "Your mother had an accident 5 years ago, a painful and emotionally draining experience for your family. Since then, she is in a persistent vegetative state. There is no chance of recovery, because large parts of her brain are permanently damaged. As a result, she experiences severe chronic pain while being unable to communicate. However, despite the state your mother is in, she might live for 20 or 30 more years. Your mother receives multiple drugs from an automatic medication dispenser. You notice that the dispenser is malfunctioning and has already given her a larger dose than your mother should be given. An overdose would cause heart failure from which your mother would die. Is it acceptable in this case to stop the medication dispenser from giving your mother an overdose?",
    d11progr:
      "Your mother had an accident 5 years ago, a painful and emotionally draining experience for your family. Since then, she is in a persistent vegetative state. There is no chance of recovery, because large parts of her brain are permanently damaged. As a result, she experiences severe chronic pain while being unable to communicate. However, despite the state your mother is in, she might live for 20 or 30 more years. Your mother receives multiple drugs from an automatic medication dispenser. An overdose would cause heart failure from which your mother would die, and nobody would notice that she did not die of natural causes. Is it acceptable in this case to set the medication dispenser to give your mother an overdose?",
    d11prosm:
      "Your mother had an accident 5 years ago, a painful and emotionally draining experience for your family. Since then, she is partially paralyzed. There is no chance of recovery, because there has been permanent tissue damage. As a result, she will need a wheelchair for the rest of her life. However, your mother has adjusted very well to the state she is in, and she might live for 20 or 30 more years. Your mother receives multiple drugs from an automatic medication dispenser. An overdose would cause heart failure from which your mother would die, and nobody would notice that she did not die of natural causes. Is it acceptable in this case to set the medication dispenser to give your mother an overdose?",
    d11pregr:
      "Your mother had an accident 5 years ago, a painful and emotionally draining experience for your family. Since then, she is partially paralyzed. There is no chance of recovery, because there has been permanent tissue damage. As a result, she will need a wheelchair for the rest of her life. However, your mother has adjusted very well to the state she is in, and she might live for 20 or 30 more years. Your mother receives multiple drugs from an automatic medication dispenser. You notice that the dispenser is malfunctioning and has already given her a larger dose than your mother should be given. An overdose would cause heart failure from which your mother would die. Is it acceptable in this case to stop the medication dispenser from giving your mother an overdose?",
  };

  let allData = [];
  let currentDilemmaId = null;
  let currentDilemmaData = [];

  fetch("/api/data")
    .then((response) => {
      if (!response.ok) {
        return response.json().then((err) => {
          throw new Error(err.error || "HTTP error status: " + response.status);
        });
      }
      return response.json();
    })
    .then((data) => {
      if (!Array.isArray(data) || data.length === 0) {
        throw new Error("No data received");
      }
      allData = data;
      console.log("Loaded", allData.length, "responses");
      loadNewDilemma();
    })
    .catch((error) => {
      console.error("Error:", error);
      document.getElementById("resultSection").style.display = "block";
      document.getElementById("dilemmaText").textContent =
        "Error: " + error.message;
    });

  function loadNewDilemma() {
    if (allData.length === 0) {
      alert("Data not loaded yet");
      return;
    }

    const allowedDilemmas = [
      "d01presm",
      "d01progr",
      "d01prosm",
      "d01pregr",
      "d02presm",
      "d02progr",
      "d02prosm",
      "d02pregr",
      "d03presm",
      "d03progr",
      "d03prosm",
      "d03pregr",
      "d04presm",
      "d04progr",
      "d04prosm",
      "d04pregr",
      "d05presm",
      "d05progr",
      "d05prosm",
      "d05pregr",
      "d06presm",
      "d06progr",
      "d06prosm",
      "d06pregr",
      "d07presm",
      "d07progr",
      "d07prosm",
      "d07pregr",
      "d08presm",
      "d08progr",
      "d08prosm",
      "d08pregr",
      "d09presm",
      "d09progr",
      "d09prosm",
      "d09pregr",
      "d10presm",
      "d10progr",
      "d10prosm",
      "d10pregr",
      "d11presm",
      "d11progr",
      "d11prosm",
      "d11pregr",
    ];

    const filteredData = allData.filter((row) =>
      allowedDilemmas.includes(row.dilemma_id)
    );

    if (filteredData.length === 0) {
      alert("No dilemmas d01-d11 found");
      return;
    }

    const availableDilemmas = [
      ...new Set(filteredData.map((row) => row.dilemma_id)),
    ];
    currentDilemmaId =
      availableDilemmas[Math.floor(Math.random() * availableDilemmas.length)];
    currentDilemmaData = allData.filter(
      (row) => row.dilemma_id === currentDilemmaId
    );

    const dilemmaText =
      dilemmas[currentDilemmaId] || "Dilemma text not available";
    document.getElementById("dilemmaId").textContent =
      "Dilemma ID: " + currentDilemmaId;
    document.getElementById("dilemmaText").textContent = dilemmaText;
    document.getElementById("resultSection").style.display = "block";

    // Hide personality and response sections when loading new dilemma
    document.getElementById("personalityCard").style.display = "none";
    document.getElementById("responseCard").style.display = "none";
  }

  function randomizePersonality() {
    if (currentDilemmaData.length === 0) {
      alert("Please wait for dilemma to load");
      return;
    }

    const randomResponse =
      currentDilemmaData[Math.floor(Math.random() * currentDilemmaData.length)];

    // Show personality card
    document.getElementById("personalityCard").style.display = "block";
    document.getElementById("agentId").textContent =
      randomResponse.participant_id;

    const traits = [
      "openness",
      "conscientiousness",
      "extraversion",
      "agreeableness",
      "neuroticism",
    ];
    traits.forEach((trait) => {
      const value = randomResponse[trait];
      updateSlider(trait, value);
    });

    // Show response card after a delay
    setTimeout(() => {
      document.getElementById("responseCard").style.display = "block";
      const answerDiv = document.getElementById("responseAnswer");
      answerDiv.textContent = randomResponse.response_parsed;
      answerDiv.className =
        "response-answer " +
        (randomResponse.response_parsed.toLowerCase() === "yes" ? "yes" : "no");
      document.getElementById("responseExplanation").textContent =
        randomResponse.response_raw;

      // Scroll to response
      document
        .getElementById("responseCard")
        .scrollIntoView({ behavior: "smooth", block: "nearest" });
    }, 1000);
  }

  function updateSlider(trait, value) {
    document.getElementById(trait + "Value").textContent = value.toFixed(1);
    const thumb = document.getElementById(trait + "Thumb");
    // Convert 0-5 scale to 0-100 percentage for slider position
    const percentage = (value / 5) * 100;
    thumb.style.left = percentage + "%";
  }
</script>
<script>
  let artificialData = [];

  fetch("/api/artificial-data")
    .then((response) => response.json())
    .then((data) => {
      artificialData = data;
      console.log(
        "Loaded artificial data:",
        artificialData.length,
        "participants"
      );
      createAllCharts();
    })
    .catch((error) => {
      console.error("Error loading data:", error);
      document.querySelectorAll(".chart-container").forEach((container) => {
        container.innerHTML =
          '<p style="color: white; text-align: center;">Error loading data. Please check console.</p>';
      });
    });

  function createAllCharts() {
    createCNIByTraitChart("Open", "Openness", "#chart1");
    createCNIByTraitChart("Con", "Conscientiousness", "#chart2");
    createCNIByTraitChart("Extra", "Extraversion", "#chart3");
    createCNIByTraitChart("Agree", "Agreeableness", "#chart4");
    createCNIByTraitChart("Neuro", "Neuroticism", "#chart5");
  }

  function createCNIByTraitChart(traitKey, traitName, containerId) {
    const bins = ["Very Low", "Low", "Medium", "High", "Very High"];

    const sortedValues = artificialData
      .map((d) => d[traitKey])
      .sort((a, b) => a - b);
    const p20 = d3.quantile(sortedValues, 0.2);
    const p40 = d3.quantile(sortedValues, 0.4);
    const p60 = d3.quantile(sortedValues, 0.6);
    const p80 = d3.quantile(sortedValues, 0.8);

    const binnedData = artificialData.map((d) => ({
      ...d,
      bin:
        d[traitKey] <= p20
          ? "Very Low"
          : d[traitKey] <= p40
          ? "Low"
          : d[traitKey] <= p60
          ? "Medium"
          : d[traitKey] <= p80
          ? "High"
          : "Very High",
    }));

    const aggregated = bins.map((bin) => {
      const filtered = binnedData.filter((d) => d.bin === bin);
      return {
        bin: bin,
        C: d3.mean(filtered, (d) => d.C_artificial),
        N: d3.mean(filtered, (d) => d.N_artificial),
        I: d3.mean(filtered, (d) => d.I_artificial),
        count: filtered.length,
      };
    });

    const margin = { top: 20, right: 30, bottom: 90, left: 60 };
    const width = 800 - margin.left - margin.right;
    const height = 400 - margin.top - margin.bottom;

    const svg = d3
      .select(containerId)
      .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

    const x0 = d3.scaleBand().domain(bins).range([0, width]).padding(0.2);
    const x1 = d3
      .scaleBand()
      .domain(["C", "N", "I"])
      .range([0, x0.bandwidth()])
      .padding(0.05);
    const y = d3.scaleLinear().domain([0, 1]).nice().range([height, 0]);

    // Website color palette: teal, purple, yellow
    const colors = {
      C: "#1b6d80", // Teal (Consequences)
      N: "#8c78c8", // Purple (Norms)
      I: "#f8d697", // Yellow (Inaction)
    };

    svg
      .append("g")
      .attr("class", "grid")
      .call(d3.axisLeft(y).ticks(5).tickSize(-width).tickFormat(""));
    svg
      .append("g")
      .attr("class", "axis")
      .attr("transform", `translate(0,${height})`)
      .call(d3.axisBottom(x0))
      .selectAll("text")
      .style("fill", "white");
    svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(5));

    svg
      .append("text")
      .attr("transform", "rotate(-90)")
      .attr("y", 0 - margin.left)
      .attr("x", 0 - height / 2)
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .style("fill", "white")
      .style("font-size", "14px")
      .text("Average Score");

    svg
      .append("text")
      .attr("x", width / 2)
      .attr("y", height + 35)
      .style("text-anchor", "middle")
      .style("fill", "white")
      .style("font-size", "14px")
      .text(`${traitName} Level`);

    const tooltip = d3.select("#tooltip");
    const binGroups = svg
      .selectAll(".bin-group")
      .data(aggregated)
      .enter()
      .append("g")
      .attr("class", "bin-group")
      .attr("transform", (d) => `translate(${x0(d.bin)},0)`);

    ["C", "N", "I"].forEach((param) => {
      binGroups
        .append("rect")
        .attr("x", x1(param))
        .attr("y", (d) => y(d[param]))
        .attr("width", x1.bandwidth())
        .attr("height", (d) => height - y(d[param]))
        .attr("fill", colors[param])
        .attr("opacity", 0.85)
        .style("cursor", "pointer")
        .on("mouseover", function (event, d) {
          d3.select(this).transition().duration(200).attr("opacity", 1);
          tooltip
            .style("opacity", 1)
            .html(
              `<strong>${traitName}: ${
                d.bin
              }</strong><br><strong style="color: ${
                colors[param]
              };">${param} Parameter:</strong> ${d[param].toFixed(
                3
              )}<br><small>n = ${d.count} participants</small>`
            );
        })
        .on("mousemove", function (event) {
          tooltip
            .style("left", event.pageX + 15 + "px")
            .style("top", event.pageY - 15 + "px");
        })
        .on("mouseout", function () {
          d3.select(this).transition().duration(200).attr("opacity", 0.85);
          tooltip.style("opacity", 0);
        });

      binGroups
        .append("text")
        .attr("class", "bar-label")
        .attr("x", x1(param) + x1.bandwidth() / 2)
        .attr("y", (d) => y(d[param]) - 5)
        .attr("text-anchor", "middle")
        .text((d) => d[param].toFixed(2))
        .style("font-size", "10px")
        .style("fill", "white");
    });

    // Legend positioned below graph
    const legend = svg
      .append("g")
      .attr("transform", `translate(${width / 2 - 150}, ${height + 60})`);
    const legendItems = [
      { label: "Consequences", color: colors.C },
      { label: "Norms", color: colors.N },
      { label: "Inaction", color: colors.I },
    ];

    legendItems.forEach((item, i) => {
      const g = legend
        .append("g")
        .attr("transform", `translate(${i * 100}, 0)`);
      g.append("rect")
        .attr("width", 12)
        .attr("height", 12)
        .attr("fill", item.color)
        .attr("opacity", 0.85);
      g.append("text")
        .attr("x", 18)
        .attr("y", 10)
        .text(item.label)
        .style("font-size", "10px")
        .style("fill", "white");
    });
  }
</script>
{% endblock %}
